FROM mcr.microsoft.com/dotnet/sdk:6.0-alpine@sha256:206e5e725e035358ad40dc23461b048948d0b5c020940d5b54949921ebb2fe53 as build

# renovate: datasource=git-refs depName=https://github.com/microsoft/wopi-validator-core versioning=git
ENV WOPI_VALIDATOR_VERSION="${WOPI_VALIDATOR_VERSION:-8d93be8b5005b9a000df0ee064ecd361ce3d2fea}"

WORKDIR /
ADD https://github.com/microsoft/wopi-validator-core/archive/$WOPI_VALIDATOR_VERSION.tar.gz /wopi-validator-core.tar.gz
RUN tar xvfz wopi-validator-core.tar.gz --directory /
RUN mv /wopi-validator-core-$WOPI_VALIDATOR_VERSION /app

WORKDIR /app/
RUN dotnet build -c Release
RUN find /app/src/WopiValidator/bin/Release

FROM mcr.microsoft.com/dotnet/runtime:6.0-alpine@sha256:53f647e1a7a6f4accb7922657e8ab4dd42d0c6e2acbef3f1928153cffd0a5d92

LABEL maintainer="ownCloud GmbH <devops@owncloud.com>"
LABEL org.opencontainers.image.authors="ownCloud DevOps <devops@owncloud.com>"
LABEL org.opencontainers.image.title="ownCloud CI wopi-validator"
LABEL org.opencontainers.image.url="https://hub.docker.com/r/owncloudci/wopi-validator"
LABEL org.opencontainers.image.source="https://github.com/owncloud-ci/wopi-validator"
LABEL org.opencontainers.image.documentation="https://github.com/owncloud-ci/wopi-validator"

WORKDIR /app/
COPY --from=build /app/LICENSE /app/LICENSE
COPY --from=build /app/src/WopiValidator/bin/Release/net6.0 /app

ENTRYPOINT [ "/app/Microsoft.Office.WopiValidator"]
